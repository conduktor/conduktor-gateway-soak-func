title: Virtual SQL with Avro
services:
  kafka1:
    environment:
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
    properties:
      bootstrap.servers: localhost:29092,localhost:29093,localhost:29094
      auto.offset.reset: earliest
      enable.auto.commit: false
      client.id: clientId
  kafka2:
    environment:
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
    properties:
      bootstrap.servers: localhost:29092,localhost:29093,localhost:29094
      auto.offset.reset: earliest
      enable.auto.commit: false
      client.id: clientId
  kafka3:
    environment:
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
    properties:
      bootstrap.servers: localhost:29092,localhost:29093,localhost:29094
      auto.offset.reset: earliest
      enable.auto.commit: false
      client.id: clientId
  gateway1:
    docker:
      environment:
        GATEWAY_ADVERTISED_HOST: localhost
        GATEWAY_SECURITY_PROTOCOL: SASL_PLAINTEXT
        GATEWAY_FEATURE_FLAGS_MULTI_TENANCY: true
    properties:
      bootstrap.servers: localhost:6969,localhost:7969
      auto.offset.reset: earliest
      enable.auto.commit: false
      client.id: clientId
  gateway2:
    docker:
      environment:
        GATEWAY_ADVERTISED_HOST: localhost
        GATEWAY_SECURITY_PROTOCOL: SASL_PLAINTEXT
        GATEWAY_FEATURE_FLAGS_MULTI_TENANCY: true
    properties:
      bootstrap.servers: localhost:6969,localhost:7969
      auto.offset.reset: earliest
      enable.auto.commit: false
      client.id: clientId
actions:

  - type: CREATE_VIRTUAL_CLUSTERS
    gateway: gateway1
    names:
      - teamA

  - type: CREATE_TOPICS
    kafka: teamA
    kafkaConfig: teamA-sa.properties
    topics:
      - name: cars
        replicationFactor: 1
        partitions: 1

  - type: LIST_TOPICS
    kafka: teamA
    kafkaConfig: teamA-sa.properties
    assertExists:
      - cars

  - type: SH
    kafka: teamA
    kafkaConfig: teamA-sa.properties
    showOutput: true
    script: |
      PATH=$PATH:/Users/framiere/confluent-7.4.1/bin
      echo '{"type":"Sports","price":75,"color":"blue"}' | \
          kafka-avro-console-producer  \
              --bootstrap-server ${BOOTSTRAP_SERVERS} \
              --producer.config teamA.properties \
              --topic cars \
              --property schema.registry.url=http://localhost:8081 \
              --property value.schema='{
                  "type": "record",
                  "name": "car",
                  "fields": [
                    {"name": "type", "type": "string"},
                    {"name": "price", "type": "long"},
                    {"name": "color", "type": "string"}
                  ]
                }'
      
      echo '{"type":"SUV","price":55,"color":"red"}' | \
          kafka-avro-console-producer  \
              --bootstrap-server ${BOOTSTRAP_SERVERS} \
              --producer.config teamA.properties \
              --topic cars \
              --property schema.registry.url=http://localhost:8081 \
              --property value.schema='{
                  "type": "record",
                  "name": "car",
                  "fields": [
                    {"name": "type", "type": "string"},
                    {"name": "price", "type": "long"},
                    {"name": "color", "type": "string"}
                  ]
                }'
      
  - type: SH
    kafka: teamA
    kafkaConfig: teamA-sa.properties
    showOutput: true
    script: |
      PATH=$PATH:/Users/framiere/confluent-7.4.1/bin
      kafka-avro-console-consumer  \
          --bootstrap-server ${BOOTSTRAP_SERVERS} \
          --consumer.config teamA.properties \
          --topic cars \
          --property schema.registry.url=http://localhost:8081 \
          --from-beginning \
          --max-messages 2

  - type: CREATE_TOPICS
    kafka: teamA
    kafkaConfig: teamA-sa.properties
    topics:
      - name: red-cars
        replicationFactor: 1
        partitions: 1

  - type: ADD_INTERCEPTORS
    gateway: gateway1
    interceptors:
      teamA:
        red-cars:
          "pluginClass": "io.conduktor.gateway.interceptor.VirtualSqlTopicPlugin"
          "priority": "100"
          "config": {
            "virtualTopic": "red-cars",
            "statement": "SELECT * FROM cars WHERE color = 'red'",
            "schemaRegistryConfig": {
              "host": "http://schema-registry:8081"
            }
          }

  - type: LIST_INTERCEPTORS
    gateway: gateway1
    vcluster: teamA
    assertSize: 1
    assertNames:
      - red-cars

  - type: SH
    kafka: teamA
    kafkaConfig: teamA-sa.properties
    showOutput: true
    script: |
      PATH=$PATH:/Users/framiere/confluent-7.4.1/bin
      kafka-avro-console-consumer  \
          --bootstrap-server ${BOOTSTRAP_SERVERS} \
          --consumer.config teamA.properties \
          --topic red-cars \
          --property schema.registry.url=http://localhost:8081 \
          --from-beginning \
          --max-messages 1 | grep "{" | jq
    assertOutputDoesNotContain:
      - blue
    assertOutputContains:
      - Processed a total of 1 messages
      - red

  - type: SUCCESS
